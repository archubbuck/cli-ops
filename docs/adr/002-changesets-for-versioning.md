# ADR-002: Use Changesets for Independent Package Versioning

**Status:** Accepted  
**Date:** 2025-12-26  
**Deciders:** Team  

## Context

In a monorepo with 14 shared packages and 3 CLIs, we needed a versioning and release management system that could:

- Support independent versioning (packages can have different versions)
- Generate meaningful changelogs automatically
- Enforce semantic versioning (semver) conventions
- Integrate with our GitHub-based workflow
- Provide a clear process for contributors to document changes
- Handle dependency version bumps automatically

Alternative solutions considered:
- **Lerna with fixed versioning**: All packages share the same version (too rigid)
- **Manual versioning**: Error-prone, hard to maintain changelogs
- **Semantic-release**: CI-based, less control over release timing
- **Rush.js**: Heavier solution, more complex than needed

## Decision

We will use **Changesets** for version management and changelog generation.

Workflow:
1. Developers create changesets with `pnpm changeset` when making changes
2. Changesets accumulate in `.changeset/` directory during development
3. When ready to release, run `pnpm changeset version` to bump versions
4. Changelogs are automatically generated in each package's `CHANGELOG.md`
5. Publish packages with `pnpm changeset publish`

Configuration in `.changeset/config.json`:
- Independent versioning mode (packages version independently)
- Automatic changelog generation
- GitHub releases integration

## Consequences

### Positive

- **Independent versioning**: `shared-logger` can be at v2.1.0 while `shared-config` is at v1.5.0
- **Clear contribution workflow**: Contributors document changes as part of their PR
- **Automatic changelogs**: No manual maintenance of CHANGELOG.md files
- **Dependency management**: Changesets automatically bumps dependent packages when needed
- **Semantic versioning enforcement**: Forces developers to think about breaking changes
- **GitHub integration**: Can automate releases with GitHub Actions
- **Audit trail**: Changeset files in `.changeset/` provide clear history of what changed

### Negative

- **Learning curve**: Contributors must learn the changeset workflow
- **Extra step**: Requires running `pnpm changeset` before committing
- **Merge conflicts**: Changeset files can conflict between branches (though rare)

### Neutral

- **Pre-commit enforcement**: Git hooks remind developers to add changesets when needed
- **Release cadence**: Team controls when versions are bumped (not CI-driven)

## Implementation

Changesets is configured in the following files:

- [.changeset/config.json](../../.changeset/config.json) - Changesets configuration
- [package.json](../../package.json) - Scripts for version and publish commands
- Each package has `CHANGELOG.md` auto-generated by Changesets

Key commands:
```bash
pnpm changeset              # Create a new changeset (interactive)
pnpm changeset version      # Consume changesets, bump versions
pnpm changeset publish      # Publish changed packages to npm
```

Example changeset file (`.changeset/cool-feature.md`):
```markdown
---
"@cli-ops/shared-logger": minor
"@cli-ops/cli-alpha": patch
---

Add structured logging support with custom formatters
```

## References

- [Changesets Documentation](https://github.com/changesets/changesets)
- [.changeset/ Directory](../../.changeset/)
- Related ADRs: [ADR-001 (Turborepo)](001-turborepo-for-monorepo-builds.md)

<!-- TODO: Expand with GitHub Actions automation examples -->
<!-- TODO: Add guidance on choosing major/minor/patch versions -->
